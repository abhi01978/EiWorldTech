<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EiWorldAi - PDF Notes</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
  .phone { width: 100%; max-width: 430px; margin: 0 auto; height: 100vh; overflow-y: auto; background: white; position: relative; }
  @media (min-width: 768px) { 
    .phone { border-radius: 40px; height: 860px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 12px solid #000; } 
  }
  .suggestions { max-height: 200px; overflow-y: auto; }
</style>
</head>
<body class="flex justify-center items-center min-h-screen bg-gray-100">

<div class="phone">

  <!-- Top Bar -->
  <div class="fixed top-0 left-0 right-0 bg-white shadow-sm z-40 px-5 py-4">
    <div class="flex justify-between items-center mb-3">
      <h1 class="text-xl font-bold text-[#0A3E87]">PDF Notes</h1>
      <button id="uploadBtn" class="hidden bg-[#0A3E87] text-white px-5 py-2 rounded-full font-medium shadow-lg hover:bg-blue-700 transition">
        + Upload
      </button>
    </div>

    <!-- Search Bar -->
    <div class="relative">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Search by subject or title..." 
        autocomplete="off"
        class="w-full border border-gray-300 rounded-xl px-4 py-3 pr-10 focus:outline-none focus:border-blue-500 text-sm"
      />
      <svg class="absolute right-3 top-3.5 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>

      <div id="suggestions" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-xl shadow-xl mt-1 z-50 max-h-64 overflow-y-auto hidden">
        <div id="suggestionList"></div>
        <div id="noSuggestion" class="px-4 py-3 text-gray-500 text-sm hidden">No results found</div>
      </div>
    </div>
  </div>

  <!-- Notes List -->
  <div class="pt-32 pb-32 px-5">
    <div id="notesContainer" class="space-y-4"></div>
    <div id="noNotes" class="text-center text-gray-500 mt-10">
      <p class="text-lg">No notes yet</p>
      <p>Be the first to upload!</p>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="fixed bottom-0 left-0 right-0 bg-white border-t py-3 flex justify-around text-gray-700 text-xs z-50">
    <a href="/" class="flex flex-col items-center"><img src="https://img.icons8.com/ios-filled/50/666666/home.png" class="w-6"/><span>Home</span></a>

    <a href="./news.html" class="flex flex-col items-center"><img src="https://img.icons8.com/ios-filled/50/666666/task.png" class="w-6"/><span>News</span></a>
    
    <!-- Floating + Button (Only for logged-in) -->
    <div id="floatingAddBtn" class="hidden relative -top-6">
      <div class="w-16 h-16 bg-[#0A3E87] text-white rounded-full flex justify-center items-center text-4xl shadow-2xl cursor-pointer hover:bg-blue-700 transition">+</div>
    </div>

    <a href="/pdf" class="flex flex-col items-center"><img src="https://img.icons8.com/ios-filled/50/3b82f6/book.png" class="w-6"/><span class="text-blue-600 font-bold">Notes</span></a>
    <a href="/profile" class="flex flex-col items-center relative">
      <div id="bottomProfileIcon" class="flex flex-col items-center">
        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
      </div>
      <img id="bottomProfileImg" class="rounded-full border-4 border-white shadow-xl absolute -top-5 left-1/2 -translate-x-1/2 hidden h-12 w-12 mt-4" alt="Profile"/>
      <span class="mt-2">Profile</span>
    </a>
  </div>

  <!-- Upload Modal -->
  <div id="uploadModal" class="fixed inset-0 bg-black/70 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md">
      <h2 class="text-2xl font-bold mb-4">Upload Notes / PDF</h2>
      <input type="text" id="noteTitle" placeholder="Note Title" class="w-full border rounded-xl px-4 py-3 mb-3" />
      <select id="noteSubject" class="w-full border rounded-xl px-4 py-3 mb-3">
        <option value="">Select Subject</option>
        <option>Physics</option><option>Chemistry</option><option>Maths</option>
        <option>Biology</option><option>English</option><option>Hindi</option>
        <option>History</option><option>Geography</option><option>Other</option>
      </select>
      <input type="file" id="noteFile" accept=".pdf" class="w-full border rounded-xl px-4 py-3 mb-4" />
      <div class="flex gap-3">
        <button id="cancelUpload" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold">Cancel</button>
        <button id="submitUpload" class="flex-1 py-3 bg-[#0A3E87] text-white rounded-xl font-bold">Upload</button>
      </div>
    </div>
  </div>

</div>

<script>
let isLoggedIn = false;
let allPdfs = [];

// Download Function
function downloadPDF(url, title) {
  if (!url) return alert("PDF link nahi mila!");
  fetch(url)
    .then(res => res.ok ? res.blob() : Promise.reject())
    .then(blob => {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = title + ".pdf";
      link.click();
      URL.revokeObjectURL(link.href);
    })
    .catch(() => {
      alert("Download fail, direct kholo");
      window.open(url, '_blank');
    });
}

// PDF Viewer Modal
function openInViewer(pdfUrl) {
  const modal = document.createElement('div');
  modal.id = 'pdfViewerModal';
  modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center';

  modal.innerHTML = `
    <div class="relative w-full h-full bg-white flex flex-col">
      <div class="absolute top-0 left-0 right-0 bg-white shadow-md z-10 p-4 flex justify-between items-center">
        <h3 class="text-lg font-bold text-gray-800 truncate max-w-xs">PDF Viewer</h3>
        <button id="closePdfViewer" class="bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-bold hover:bg-red-600 transition">×</button>
      </div>
      <iframe src="https://docs.google.com/viewer?url=${pdfUrl}&embedded=true" class="w-full flex-1 mt-16" frameborder="0" allowfullscreen></iframe>
    </div>
  `;

  document.body.appendChild(modal);
  document.getElementById('closePdfViewer').onclick = () => modal.remove();
  modal.onclick = (e) => e.target === modal && modal.remove();
}

// Check Login Status
async function checkAuth() {
  try {
    const res = await fetch('/api/me', { credentials: 'include' });
    if (res.ok) {
      const user = await res.json();
      isLoggedIn = true;

      // Show profile image
      if (user.profileImage) {
        document.getElementById('bottomProfileImg').src = user.profileImage;
        document.getElementById('bottomProfileImg').classList.remove('hidden');
      }

      // Show upload features
      document.getElementById('uploadBtn').classList.remove('hidden');
      document.getElementById('floatingAddBtn').classList.remove('hidden');

      // Floating button click
      document.getElementById('floatingAddBtn').onclick = () => {
        document.getElementById('uploadModal').classList.remove('hidden');
      };

    } else throw new Error();
  } catch {
    isLoggedIn = false;
    // Hide upload features
    document.getElementById('uploadBtn')?.classList.add('hidden');
    document.getElementById('floatingAddBtn')?.classList.add('hidden');
  }
}

// Load & Render PDFs
// Replace pura loadNotes() function with this
async function loadNotes() {
  try {
    const res = await fetch('/api/uploaded-pdfs');
    const data = await res.json();
    allPdfs = data.pdfs || [];

    if (allPdfs.length === 0) {
      document.getElementById('noNotes').classList.remove('hidden');
      document.getElementById('notesContainer').innerHTML = '';
      return;
    }
    document.getElementById('noNotes').classList.add('hidden');

    // Pehle auth check karo, phir render karo
    await checkAuth();        // ← Yeh line sabse important hai
    renderNotes(allPdfs);     // ← Ab isLoggedIn ka correct value milega
  } catch (err) {
    console.error(err);
  }
}

function renderNotes(pdfList) {
  const container = document.getElementById('notesContainer');
  if (pdfList.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500">No PDF found</p>';
    return;
  }

  container.innerHTML = pdfList.map(pdf => `
    <div class="bg-white border rounded-2xl p-5 shadow-sm hover:shadow-lg transition">
      <h3 class="font-bold text-lg text-[#0A3E87]">${pdf.title}</h3>
      <p class="text-sm text-gray-600">Subject: ${pdf.subject}</p>
      <p class="text-xs text-gray-500 mt-2">By ${pdf.uploaderName || 'User'} • ${new Date(pdf.createdAt).toLocaleDateString('en-IN')}</p>
      
      ${isLoggedIn ? `
        <div class="mt-4 flex gap-3 flex-wrap">
          <button onclick="downloadPDF('${pdf.secure_url || pdf.url}', '${pdf.title.replace(/'/g, "\\'")}')" 
                  class="bg-green-600 text-white px-6 py-3 rounded-full text-sm font-medium hover:bg-green-700 shadow-md">
            Download
          </button>
          <button onclick="openInViewer('${encodeURIComponent(pdf.secure_url || pdf.url)}')" 
                  class="bg-[#0A3E87] text-white px-6 py-3 rounded-full text-sm font-medium hover:bg-blue-700">
            View PDF
          </button>
        </div>
      ` : `
        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl text-center">
          <a href="/login" class="text-[#0A3E87] font-bold underline">Login</a> karke Download/View karo
        </div>
      `}
    </div>
  `).join('');
}

// Search Functionality
const searchInput = document.getElementById('searchInput');
const suggestionsDiv = document.getElementById('suggestions');
const suggestionList = document.getElementById('suggestionList');
const noSuggestion = document.getElementById('noSuggestion');

searchInput.addEventListener('input', () => {
  const query = searchInput.value.trim().toLowerCase();
  if (!query) {
    suggestionsDiv.classList.add('hidden');
    renderNotes(allPdfs);
    return;
  }

  const filtered = allPdfs.filter(pdf => 
    pdf.title.toLowerCase().includes(query) || 
    pdf.subject.toLowerCase().includes(query)
  );

  suggestionList.innerHTML = filtered.slice(0, 8).map(pdf => `
    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b" onclick="selectSuggestion('${pdf._id || pdf.title}')">
      <div class="font-medium">${pdf.title}</div>
      <div class="text-xs text-gray-500">${pdf.subject}</div>
    </div>
  `).join('');

  noSuggestion.classList.toggle('hidden', filtered.length > 0);
  suggestionsDiv.classList.remove('hidden');
  renderNotes(filtered);
});

window.selectSuggestion = function(idOrTitle) {
  const pdf = allPdfs.find(p => p._id === idOrTitle || p.title === idOrTitle);
  if (pdf) {
    searchInput.value = pdf.title;
    renderNotes([pdf]);
    suggestionsDiv.classList.add('hidden');
  }
};

document.addEventListener('click', (e) => {
  if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
    suggestionsDiv.classList.add('hidden');
  }
});

// Upload Modal
document.getElementById('uploadBtn')?.addEventListener('click', () => {
  document.getElementById('uploadModal').classList.remove('hidden');
});

document.getElementById('cancelUpload').onclick = () => {
  document.getElementById('uploadModal').classList.add('hidden');
  document.getElementById('noteTitle').value = '';
  document.getElementById('noteSubject').value = '';
  document.getElementById('noteFile').value = '';
};

document.getElementById('submitUpload').onclick = async () => {
  const title = document.getElementById('noteTitle').value.trim();
  const subject = document.getElementById('noteSubject').value;
  const file = document.getElementById('noteFile').files[0];
  if (!title || !subject || !file) return alert('Sab bharo bhai!');

  const formData = new FormData();
  formData.append('title', title);
  formData.append('subject', subject);
  formData.append('pdf', file);

  const btn = document.getElementById('submitUpload');
  btn.disabled = true;
  btn.textContent = 'Uploading...';

  try {
    const res = await fetch('/api/upload-pdf', { method: 'POST', body: formData, credentials: 'include' });
    const data = await res.json();
    if (data.success) {
      alert('Upload ho gaya bhai!');
      document.getElementById('uploadModal').classList.add('hidden');
      document.getElementById('noteTitle').value = '';
      document.getElementById('noteSubject').value = '';
      document.getElementById('noteFile').value = '';
      loadNotes();
    } else {
      alert(data.error || 'Upload fail');
    }
  } catch {
    alert('Network error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Upload';
  }
};

// Start
checkAuth();
loadNotes();
</script>

</body>
</html>