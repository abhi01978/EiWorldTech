<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Notes Generator - Student Ka Best Friend</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
    .typing { animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex flex-col">

  <!-- HEADER -->
  <header class="bg-white shadow-lg p-4 flex items-center gap-3 fixed top-0 left-0 w-full z-50 border-b-4 border-blue-600">
    <div class="w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl">Notes</div>
    <div>
      <h1 class="text-2xl font-bold text-gray-800">AI Notes Generator</h1>
      <p class="text-xs text-gray-500">Bhai, bas subject bata — notes ready!</p>
    </div>
  </header>

  <!-- MAIN CHAT -->
  <main id="chatBox" class="flex-1 mt-20 mb-24 overflow-y-auto p-4 space-y-4 max-w-4xl mx-auto w-full"></main>

  <!-- CATEGORY SELECTION (First Message) -->
  <div id="categorySelection" class="fixed inset-0 bg-black bg-opacity-50 z-60 flex items-center justify-center hidden">
    <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4 text-center">
      <h2 class="text-2xl font-bold mb-6">Tu Kaun Sa Student Hai?</h2>
      <button onclick="selectCategory('school')" class="w-full bg-green-600 text-white py-5 rounded-2xl text-xl font-bold mb-4 hover:bg-green-700">School Student (Class 1-12)</button>
      <button onclick="selectCategory('college')" class="w-full bg-purple-600 text-white py-5 rounded-2xl text-xl font-bold hover:bg-purple-700">College Student (B.Tech, B.Sc, etc)</button>
    </div>
  </div>

  <!-- INPUT BAR -->
  <div class="fixed bottom-0 left-0 w-full bg-white shadow-2xl p-4 border-t-4 border-blue-600">
    <div class="max-w-4xl mx-auto flex items-center gap-3">
      <input id="messageInput" type="text" placeholder="Yahan likho..." 
             class="flex-1 p-4 bg-gray-100 rounded-2xl outline-none text-gray-800 text-lg"
             onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" 
              class="p-4 bg-blue-600 text-white rounded-2xl shadow-lg hover:bg-blue-700 active:scale-95 transition">
        Send
      </button>
    </div>
  </div>

<script>
let step = 0;
let category = "";
let formData = {};
let currentNotes = ""; // Global variable to store notes for PDF download

// Start with category selection
window.onload = () => {
  document.getElementById("categorySelection").classList.remove("hidden");
};

function selectCategory(type) {
  category = type;
  document.getElementById("categorySelection").classList.add("hidden");
  addAiMessage("Perfect bhai! Ab step by step batao...");
  
  if (type === "school") {
    addAiMessage("Class batao (e.g. 10th, 12th)");
  } else {
    addAiMessage("Course batao (e.g. B.Tech CSE, B.Sc Physics)");
  }
  step = 1;
}

// Add User Message
function addUserMessage(text) {
  const chat = document.getElementById("chatBox");
  const div = document.createElement("div");
  div.className = "flex justify-end mb-4";
  div.innerHTML = `<div class="bg-blue-600 text-white p-4 rounded-3xl max-w-xs shadow-lg"><p class="text-lg">${text}</p></div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// Add AI Message
function addAiMessage(text, isTyping = false) {
  const chat = document.getElementById("chatBox");
  const div = document.createElement("div");
  div.className = "flex gap-3 mb-4";
  div.innerHTML = `
    <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">AI</div>
    <div class="bg-white p-4 rounded-3xl shadow-lg max-w-2xl">
      <p class="text-lg text-gray-800">${isTyping ? text + '<span class="typing">...</span>' : text}</p>
    </div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// Download as PDF (Fixed without font fetch error - 100% Working)

function downloadPDF() {
  if (!currentNotes) return alert("Bhai notes load kar le pehle!");

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Title
  doc.setFontSize(20);
  doc.setTextColor(40, 116, 166);
  doc.text("AI Generated Notes", 105, 20, { align: "center" });

  // Student Info
  doc.setFontSize(12);
  doc.setTextColor(100);
  doc.text(`Subject: ${formData.subject || "N/A"}`, 20, 35);
  doc.text(`Class: ${formData.standard || "N/A"}`, 20, 42);
  doc.text(`Board: ${formData.board || "N/A"}`, 20, 49);
  if (formData.chapter && formData.chapter !== "Full Syllabus") {
    doc.text(`Chapter: ${formData.chapter}`, 20, 56);
  }

  // Clean text (Remove symbols jo PDF mein problem dete hain)
  let cleanText = currentNotes
    .replace(/★/g, "[Important]")
    .replace(/→/g, "->")
    .replace(/✓/g, "[Correct]")
    .replace(/\*\*/g, "")
    .replace(/__/g, "")
    .replace(/#/g, "")
    .trim();

  // Split into lines
  const lines = doc.splitTextToSize(cleanText, 180);

  // Add content
  doc.setFontSize(13);
  doc.setTextColor(0, 0, 0);
  let y = 70;

  lines.forEach(line => {
    if (y > 270) {
      doc.addPage();
      y = 20;
    }
    doc.text(line, 15, y);
    y += 7;
  });

  // Footer
  doc.setFontSize(10);
  doc.setTextColor(150);
  doc.text("Made with Love by Your AI Notes App", 105, 290, { align: "center" });

  // Download
  doc.save(`${formData.subject || "Notes"}_${new Date().toLocaleDateString('en-IN')}.pdf`);
}

// Main Send Function
async function sendMessage() {
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if (!text) return;

  addUserMessage(text);
  input.value = "";

  if (step === 1) {
    formData.standard = text;
    addAiMessage("Subject batao (e.g. Physics, Maths, History)");
    step = 2;
    return;
  }

  if (step === 2) {
    formData.subject = text;
    if (category === "school") {
      addAiMessage("Board batao (e.g. UP Board, CBSE, ICSE)");
    } else {
      addAiMessage("University/Semester batao (e.g. AKTU 3rd Sem)");
    }
    step = 3;
    return;
  }

  if (step === 3) {
    formData.board = text;
    addAiMessage("Chapter/Topic (optional) bata do, warna full syllabus bana dunga!");
    step = 4;
    return;
  }

  if (step === 4) {
    formData.chapter = text || "Full Syllabus";
    addAiMessage("Thoda wait kar bhai... tere liye topper level notes bana raha hun", true);
    
    // Call Backend
    const res = await fetch("/api/notes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData)
    });

    const result = await res.json();
    currentNotes = result.notes || "Kuch gadbad ho gayi bhai, dubara try kar!"; // Save to global

    // Show Notes + PDF Button
    const chat = document.getElementById("chatBox");
    const div = document.createElement("div");
    div.className = "flex gap-3 mb-6";
    div.innerHTML = `
      <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold">AI</div>
      <div class="bg-white p-6 rounded-3xl shadow-xl max-w-3xl">
        <pre class="text-lg leading-relaxed whitespace-pre-wrap font-sans">${currentNotes}</pre>
        <button onclick="downloadPDF()" 
                class="mt-4 px-6 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 shadow-lg">
          Download PDF
        </button>
      </div>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    step = 0; // Reset for next
  }
}
</script>

</body>
</html>